function udef = diffDefEnergy(q,dq,s,EA,EI,nu)

rx1 = q(1);  ry1  = q(2); rz1 = q(3); rx2 = q(4); ry2 = q(5); rz2  = q(6);
qx1 = q(7); qx2  = q(8); qx3  = q(9); qy1  = q(10); qy2  = q(11); qy3  = q(12); qz1  = q(13); qz2  = q(14); qz3  = q(15);
s1 = q(16); s2 = q(17);

drx1 = dq(1);  dry1  = dq(2); drz1 = dq(3); drx2 = dq(4); dry2 = dq(5); drz2  = dq(6);
dqx1 = dq(7); dqx2  = dq(8); dqx3  = dq(9); dqy1  = dq(10); dqy2  = dq(11); dqy3  = dq(12); dqz1  = dq(13); dqz2  = dq(14); dqz3  = dq(15);
ds1 = dq(16); ds2 = dq(17);

t2 = pi.^2;
t4 = rx1.*2.0;
t5 = rx2.*2.0;
t6 = ry1.*2.0;
t7 = ry2.*2.0;
t8 = rz1.*2.0;
t9 = rz2.*2.0;
t10 = -rx2;
t12 = -ry2;
t14 = -rz2;
t16 = -s1;
t17 = -s2;
t3 = t2.^2;
t11 = -t5;
t13 = -t7;
t15 = -t9;
t18 = rx1+t10;
t19 = ry1+t12;
t20 = rz1+t14;
t21 = s+t16;
t22 = s1+t17;
t23 = t4+t11;
t24 = t6+t13;
t25 = t18.^2;
t26 = t8+t15;
t27 = t19.^2;
t28 = t20.^2;
t29 = 1.0./t22;
t30 = t29.^2;
t31 = t29.^3;
t33 = t29.*pi;
t34 = rx1.*t29;
t36 = rx2.*t29;
t38 = ry1.*t29;
t40 = ry2.*t29;
t42 = rz1.*t29;
t44 = rz2.*t29;
t48 = t10.*t29;
t50 = t12.*t29;
t52 = t14.*t29;
t72 = t25+t27+t28;
t32 = t30.^2;
t35 = rx1.*t30;
t37 = rx2.*t30;
t39 = ry1.*t30;
t41 = ry2.*t30;
t43 = rz1.*t30;
t45 = rz2.*t30;
t46 = t33.*2.0;
t47 = t33.*3.0;
t49 = t10.*t30;
t51 = t12.*t30;
t53 = t14.*t30;
t54 = t21.*t33;
t55 = t21.*t30.*pi;
t74 = 1.0./sqrt(t72);
t56 = t21.*t46;
t57 = t21.*t47;
t58 = t55.*2.0;
t59 = t55.*3.0;
t60 = cos(t54);
t61 = sin(t54);
t73 = t33+t55;
t75 = t74.^3;
t62 = cos(t56);
t63 = cos(t57);
t64 = sin(t56);
t65 = sin(t57);
t66 = t60.^2;
t67 = t61.^2;
t76 = t46+t58;
t77 = t47+t59;
t78 = qx1.*t33.*t60.*t74;
t82 = qx1.*t18.*t30.*t60.*t74.*pi;
t84 = qx1.*t19.*t30.*t60.*t74.*pi;
t86 = qx1.*t20.*t30.*t60.*t74.*pi;
t108 = (qx1.*t18.*t23.*t33.*t60.*t75)./2.0;
t110 = (qx1.*t19.*t23.*t33.*t60.*t75)./2.0;
t111 = (qx1.*t18.*t24.*t33.*t60.*t75)./2.0;
t112 = (qx1.*t20.*t23.*t33.*t60.*t75)./2.0;
t113 = (qx1.*t19.*t24.*t33.*t60.*t75)./2.0;
t114 = (qx1.*t18.*t26.*t33.*t60.*t75)./2.0;
t116 = (qx1.*t20.*t24.*t33.*t60.*t75)./2.0;
t117 = (qx1.*t19.*t26.*t33.*t60.*t75)./2.0;
t118 = (qx1.*t20.*t26.*t33.*t60.*t75)./2.0;
t68 = t62.^2;
t69 = t63.^2;
t70 = t64.^2;
t71 = t65.^2;
t79 = qx2.*t46.*t62.*t74;
t80 = qx3.*t47.*t63.*t74;
t81 = t18.*t78;
t83 = t19.*t78;
t85 = t20.*t78;
t88 = qx2.*t18.*t30.*t62.*t74.*pi.*2.0;
t90 = qx3.*t18.*t30.*t63.*t74.*pi.*3.0;
t92 = qx2.*t19.*t30.*t62.*t74.*pi.*2.0;
t94 = qx3.*t19.*t30.*t63.*t74.*pi.*3.0;
t96 = qx2.*t20.*t30.*t62.*t74.*pi.*2.0;
t98 = qx3.*t20.*t30.*t63.*t74.*pi.*3.0;
t99 = qx2.*t18.*t23.*t33.*t62.*t75;
t100 = qx2.*t19.*t23.*t33.*t62.*t75;
t101 = qx2.*t18.*t24.*t33.*t62.*t75;
t102 = qx2.*t20.*t23.*t33.*t62.*t75;
t103 = qx2.*t19.*t24.*t33.*t62.*t75;
t104 = qx2.*t18.*t26.*t33.*t62.*t75;
t105 = qx2.*t20.*t24.*t33.*t62.*t75;
t106 = qx2.*t19.*t26.*t33.*t62.*t75;
t107 = qx2.*t20.*t26.*t33.*t62.*t75;
t120 = -t108;
t121 = qx3.*t18.*t23.*t33.*t63.*t75.*(3.0./2.0);
t122 = qx3.*t19.*t23.*t33.*t63.*t75.*(3.0./2.0);
t123 = qx3.*t18.*t24.*t33.*t63.*t75.*(3.0./2.0);
t124 = -t113;
t125 = qx3.*t20.*t23.*t33.*t63.*t75.*(3.0./2.0);
t126 = qx3.*t19.*t24.*t33.*t63.*t75.*(3.0./2.0);
t127 = qx3.*t18.*t26.*t33.*t63.*t75.*(3.0./2.0);
t128 = qx3.*t20.*t24.*t33.*t63.*t75.*(3.0./2.0);
t129 = qx3.*t19.*t26.*t33.*t63.*t75.*(3.0./2.0);
t130 = -t118;
t131 = qx3.*t20.*t26.*t33.*t63.*t75.*(3.0./2.0);
t87 = t18.*t79;
t89 = t18.*t80;
t91 = t19.*t79;
t93 = t19.*t80;
t95 = t20.*t79;
t97 = t20.*t80;
t109 = -t99;
t115 = -t103;
t119 = -t107;
t132 = -t121;
t133 = -t126;
t134 = -t131;
t141 = t100+t110+t122;
t142 = t101+t111+t123;
t143 = t102+t112+t125;
t144 = t104+t114+t127;
t145 = t105+t116+t128;
t146 = t106+t117+t129;
t135 = t34+t48+t81+t87+t89;
t136 = t38+t50+t83+t91+t93;
t137 = t42+t52+t85+t95+t97;
t150 = t29+t78+t79+t80+t109+t120+t132;
t151 = t29+t78+t79+t80+t115+t124+t133;
t152 = t29+t78+t79+t80+t119+t130+t134;
t138 = t135.^2;
t139 = t136.^2;
t140 = t137.^2;
t153 = t135.*t142;
t154 = t135.*t144;
t155 = t136.*t141;
t156 = t136.*t146;
t157 = t137.*t143;
t158 = t137.*t145;
t159 = t135.*t150;
t160 = t136.*t151;
t161 = t137.*t152;
t147 = t138./2.0;
t148 = t139./2.0;
t149 = t140./2.0;
t162 = -t159;
t163 = -t160;
t164 = -t161;
t165 = t147+t148+t149-1.0./2.0;
t166 = t155+t157+t162;
t167 = t153+t158+t163;
t168 = t154+t156+t164;
udef = qy1.*((EI.*qy1.*t3.*t32.*t67)./2.0+EI.*qy2.*t3.*t32.*t61.*t64.*2.0+EI.*qy3.*t3.*t32.*t61.*t65.*(9.0./2.0))+qy2.*(EI.*qy2.*t3.*t32.*t70.*8.0+EI.*qy1.*t3.*t32.*t61.*t64.*2.0+EI.*qy3.*t3.*t32.*t64.*t65.*1.8e+1)+qy3.*(EI.*qy3.*t3.*t32.*t71.*(8.1e+1./2.0)+EI.*qy1.*t3.*t32.*t61.*t65.*(9.0./2.0)+EI.*qy2.*t3.*t32.*t64.*t65.*1.8e+1)+qz1.*((EI.*qz1.*t3.*t32.*t67)./2.0+EI.*qz2.*t3.*t32.*t61.*t64.*2.0+EI.*qz3.*t3.*t32.*t61.*t65.*(9.0./2.0))+qz2.*(EI.*qz2.*t3.*t32.*t70.*8.0+EI.*qz1.*t3.*t32.*t61.*t64.*2.0+EI.*qz3.*t3.*t32.*t64.*t65.*1.8e+1)+qz3.*(EI.*qz3.*t3.*t32.*t71.*(8.1e+1./2.0)+EI.*qz1.*t3.*t32.*t61.*t65.*(9.0./2.0)+EI.*qz2.*t3.*t32.*t64.*t65.*1.8e+1)+qy1.*((EA.*qy1.*t2.*t30.*t66.*t165)./2.0+EA.*qy2.*t2.*t30.*t60.*t62.*t165+EA.*qy3.*t2.*t30.*t60.*t63.*t165.*(3.0./2.0))+qy2.*(EA.*qy2.*t2.*t30.*t68.*t165.*2.0+EA.*qy1.*t2.*t30.*t60.*t62.*t165+EA.*qy3.*t2.*t30.*t62.*t63.*t165.*3.0)+qy3.*(EA.*qy3.*t2.*t30.*t69.*t165.*(9.0./2.0)+EA.*qy1.*t2.*t30.*t60.*t63.*t165.*(3.0./2.0)+EA.*qy2.*t2.*t30.*t62.*t63.*t165.*3.0)+qz1.*((EA.*qz1.*t2.*t30.*t66.*t165)./2.0+EA.*qz2.*t2.*t30.*t60.*t62.*t165+EA.*qz3.*t2.*t30.*t60.*t63.*t165.*(3.0./2.0))+qz2.*(EA.*qz2.*t2.*t30.*t68.*t165.*2.0+EA.*qz1.*t2.*t30.*t60.*t62.*t165+EA.*qz3.*t2.*t30.*t62.*t63.*t165.*3.0)+qz3.*(EA.*qz3.*t2.*t30.*t69.*t165.*(9.0./2.0)+EA.*qz1.*t2.*t30.*t60.*t63.*t165.*(3.0./2.0)+EA.*qz2.*t2.*t30.*t62.*t63.*t165.*3.0)+(EA.*t165.*(t165+nu.*(dqx1.*(t18.*t33.*t60.*t74.*t135+t19.*t33.*t60.*t74.*t136+t20.*t33.*t60.*t74.*t137)+dqx2.*(t18.*t46.*t62.*t74.*t135+t19.*t46.*t62.*t74.*t136+t20.*t46.*t62.*t74.*t137)+dqx3.*(t18.*t47.*t63.*t74.*t135+t19.*t47.*t63.*t74.*t136+t20.*t47.*t63.*t74.*t137)-drx1.*t166+drx2.*t166-dry1.*t167+dry2.*t167-drz1.*t168+drz2.*t168-ds1.*(t135.*(t35+t49+t82+t88+t90-qx1.*t18.*t33.*t61.*t73.*t74-qx2.*t18.*t33.*t64.*t74.*t76.*2.0-qx3.*t18.*t33.*t65.*t74.*t77.*3.0)+t136.*(t39+t51+t84+t92+t94-qx1.*t19.*t33.*t61.*t73.*t74-qx2.*t19.*t33.*t64.*t74.*t76.*2.0-qx3.*t19.*t33.*t65.*t74.*t77.*3.0)+t137.*(t43+t53+t86+t96+t98-qx1.*t20.*t33.*t61.*t73.*t74-qx2.*t20.*t33.*t64.*t74.*t76.*2.0-qx3.*t20.*t33.*t65.*t74.*t77.*3.0))+ds2.*(t135.*(t35+t49+t82+t88+t90-qx1.*t2.*t18.*t21.*t31.*t61.*t74-qx2.*t2.*t18.*t21.*t31.*t64.*t74.*4.0-qx3.*t2.*t18.*t21.*t31.*t65.*t74.*9.0)+t136.*(t39+t51+t84+t92+t94-qx1.*t2.*t19.*t21.*t31.*t61.*t74-qx2.*t2.*t19.*t21.*t31.*t64.*t74.*4.0-qx3.*t2.*t19.*t21.*t31.*t65.*t74.*9.0)+t137.*(t43+t53+t86+t96+t98-qx1.*t2.*t20.*t21.*t31.*t61.*t74-qx2.*t2.*t20.*t21.*t31.*t64.*t74.*4.0-qx3.*t2.*t20.*t21.*t31.*t65.*t74.*9.0)))))./2.0;
